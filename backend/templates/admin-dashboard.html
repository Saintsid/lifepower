{% extends "base.html" %}

{% block title %}Админ-панель | Сила жизни{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <div>
            <h2>Админ-панель</h2>
            <p id="userName">Загрузка...</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3 id="statTotalBookings">-</h3>
            <p>Всего записей</p>
        </div>
        <div class="stat-card">
            <h3 id="statNewBookings">-</h3>
            <p>Новых заявок</p>
        </div>
        <div class="stat-card">
            <h3 id="statConfirmedBookings">-</h3>
            <p>Подтверждено</p>
        </div>
        <div class="stat-card">
            <h3 id="statCompletedBookings">-</h3>
            <p>Завершено</p>
        </div>
        <div class="stat-card">
            <h3 id="statTotalUsers">-</h3>
            <p>Клиентов</p>
        </div>
    </div>

    <section>
        <h3>Все записи</h3>
        <table class="bookings-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Дата</th>
                    <th>Имя</th>
                    <th>Телефон</th>
                    <th>Email</th>
                    <th>Услуга</th>
                    <th>Статус</th>
                    <th>Комментарий</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="bookingsBody">
                <tr>
                    <td colspan="9" style="text-align: center;">Загрузка...</td>
                </tr>
            </tbody>
        </table>
    </section>
</div>
<div id="commentModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeCommentModal()"></div>
    <div class="modal-content">
        <h4>Комментарий к заявке #<span id="commentModalBookingId"></span></h4>
        <textarea id="commentModalTextarea" placeholder="Введите комментарий..."></textarea>
        <div class="modal-actions">
            <button type="button" class="button-secondary" onclick="closeCommentModal()">Отмена</button>
            <button type="button" class="button-primary" onclick="saveComment()">Сохранить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/auth.js"></script>
<script>
const statusLabels = {
    'new': 'Новая',
    'contacted': 'Связались',
    'confirmed': 'Подтверждена',
    'completed': 'Завершена',
    'cancelled': 'Отменена'
};

async function loadStats() {
    const response = await apiRequest('/admin/stats');
    if (response.ok) {
        const stats = await response.json();
        document.getElementById('statTotalBookings').textContent = stats.total_bookings;
        document.getElementById('statNewBookings').textContent = stats.new_bookings;
        document.getElementById('statConfirmedBookings').textContent = stats.confirmed_bookings;
        document.getElementById('statCompletedBookings').textContent = stats.completed_bookings;
        document.getElementById('statTotalUsers').textContent = stats.total_users;
    }
}

async function loadBookings() {
    const response = await apiRequest('/admin/bookings');
    if (response.ok) {
        const bookings = await response.json();
        const tbody = document.getElementById('bookingsBody');

        if (bookings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Записей пока нет</td></tr>';
            return;
        }

        tbody.innerHTML = bookings.map(b => `
            <tr>
                <td>${b.id}</td>
                <td>${new Date(b.created_at).toLocaleDateString('ru-RU')}</td>
                <td>${b.name}</td>
                <td><a href="tel:${b.phone}">${b.phone}</a></td>
                <td>${b.email || '-'}</td>
                <td>${b.service || '-'}</td>
                <td><span class="status-badge status-${b.status}">${statusLabels[b.status]}</span></td>
                <td>
                    <button class="comment-button ${b.comment ? 'comment-button--filled' : ''}" onclick="openCommentModal(${b.id}, ${JSON.stringify(b.comment || '')})">
                        Комментарий
                    </button>
                </td>
                <td>
                    <select class="status-select" onchange="updateStatus(${b.id}, this.value)" data-current="${b.status}">
                        <option value="">Изменить...</option>
                        <option value="new">Новая</option>
                        <option value="contacted">Связались</option>
                        <option value="confirmed">Подтверждена</option>
                        <option value="completed">Завершена</option>
                        <option value="cancelled">Отменена</option>
                    </select>
                </td>
            </tr>
        `).join('');
    }
}

async function updateStatus(bookingId, newStatus) {
    if (!newStatus) return;

    const response = await apiRequest(`/admin/bookings/${bookingId}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: newStatus })
    });

    if (response.ok) {
        await loadBookings();
        await loadStats();
    } else {
        alert('Ошибка при обновлении статуса');
    }
}

async function loadDashboard() {
    const user = await getCurrentUser();
    if (!user) {
        window.location.href = '/login';
        return;
    }

    if (user.role !== 'admin') {
        window.location.href = '/client-dashboard';
        return;
    }

    document.getElementById('userName').textContent = `${user.name} (Администратор)`;

    await loadStats();
    await loadBookings();
}

let currentCommentBookingId = null;

function openCommentModal(bookingId, comment) {
    currentCommentBookingId = bookingId;

    const modal = document.getElementById('commentModal');
    const textarea = document.getElementById('commentModalTextarea');
    const bookingIdLabel = document.getElementById('commentModalBookingId');

    bookingIdLabel.textContent = bookingId;
    textarea.value = comment || '';

    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    textarea.focus();
}

function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
        document.body.classList.remove('modal-open');
    }
    currentCommentBookingId = null;
}

async function saveComment() {
    if (!currentCommentBookingId) {
        return;
    }

    const textarea = document.getElementById('commentModalTextarea');
    const rawComment = textarea.value;
    const comment = rawComment.trim() === '' ? null : rawComment;

    const response = await apiRequest(`/admin/bookings/${currentCommentBookingId}/comment`, {
        method: 'PATCH',
        body: JSON.stringify({ comment })
    });

    if (response.ok) {
        closeCommentModal();
        await loadBookings();
    } else {
        alert('Ошибка при сохранении комментария');
    }
}

document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        closeCommentModal();
    }
});

loadDashboard();
</script>
<style>
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}
.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}
.stat-card h3 {
    font-size: 2rem;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}
.stat-card p {
    color: var(--text-light);
    font-size: 0.9rem;
}
.bookings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
}
.bookings-table th,
.bookings-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.bookings-table th {
    background: var(--primary-color);
    color: white;
}
.status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
}
.status-new { background: #fef3c7; color: #92400e; }
.status-contacted { background: #dbeafe; color: #1e40af; }
.status-confirmed { background: #d1fae5; color: #065f46; }
.status-completed { background: #e5e7eb; color: #374151; }
.status-cancelled { background: #fee2e2; color: #991b1b; }
.status-select {
    padding: 0.4rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.comment-button {
    padding: 0.5rem 0.8rem;
    border-radius: 4px;
    border: 1px solid var(--primary-color);
    background: white;
    color: var(--primary-color);
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
}
.comment-button:hover {
    background: var(--primary-color);
    color: white;
}
.comment-button--filled {
    background: var(--primary-color);
    color: white;
}
.modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal.hidden {
    display: none;
}
.modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
}
.modal-content {
    position: relative;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 500px;
    width: 100%;
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}
.modal-content textarea {
    min-height: 160px;
    padding: 0.8rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    font-size: 1rem;
}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.8rem;
}
.button-secondary,
.button-primary {
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}
.button-secondary {
    background: #f3f4f6;
    color: #374151;
}
.button-secondary:hover {
    background: #e5e7eb;
}
.button-primary {
    background: var(--primary-color);
    color: white;
}
.button-primary:hover {
    opacity: 0.9;
}
body.modal-open {
    overflow: hidden;
}
</style>
{% endblock %}
