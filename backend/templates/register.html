{% extends "base.html" %}

{% block title %}Регистрация | Сила жизни{% endblock %}

{% block content %}
<main>
    <div class="auth-container">
        <h2>Регистрация</h2>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        <form id="registerForm">
            <div class="form-group">
                <label for="name">Ваше имя *</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="phone">Телефон *</label>
                <input type="tel" id="phone" required placeholder="+7 (___) ___-__-__">
            </div>
            <div class="form-group">
                <label for="email">Электронная почта *</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль *</label>
                <input type="password" id="password" required minlength="6">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: flex-start; gap: 0.5rem;">
                    <input type="checkbox" id="agreePrivacy" required style="margin-top: 0.2rem;">
                    <span>Я согласен с <a href="/privacy" target="_blank">политикой конфиденциальности</a></span>
                </label>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Зарегистрироваться</button>
        </form>
        <p style="text-align: center; margin-top: 1rem;">
            Уже есть аккаунт? <a href="/login">Войти</a>
        </p>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="/static/js/auth.js"></script>
<script src="/static/js/form.js"></script>
<script>
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorDiv = document.getElementById('errorMessage');
    const successDiv = document.getElementById('successMessage');
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const response = await apiRequest('/register', {
            method: 'POST',
            body: JSON.stringify({ name, phone, email, password })
        });

        if (response.ok) {
            successDiv.textContent = 'Регистрация успешна! Переход на страницу входа...';
            successDiv.style.display = 'block';
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            const error = await response.json();
            errorDiv.textContent = error.detail || 'Ошибка регистрации';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = 'Ошибка подключения к серверу';
        errorDiv.style.display = 'block';
    }
});

// Кастомные сообщения валидации
document.getElementById('name').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите ваше имя');
};
document.getElementById('name').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('phone').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите номер телефона');
};
document.getElementById('phone').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('email').oninvalid = function(e) {
    if (e.target.validity.valueMissing) {
        e.target.setCustomValidity('Пожалуйста, введите email адрес');
    } else if (e.target.validity.typeMismatch) {
        e.target.setCustomValidity('Пожалуйста, введите корректный email адрес');
    }
};
document.getElementById('email').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('password').oninvalid = function(e) {
    if (e.target.validity.valueMissing) {
        e.target.setCustomValidity('Пожалуйста, введите пароль');
    } else if (e.target.validity.tooShort) {
        e.target.setCustomValidity('Пароль должен содержать минимум 6 символов');
    }
};
document.getElementById('password').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('agreePrivacy').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, согласитесь с политикой конфиденциальности');
};
document.getElementById('agreePrivacy').onchange = function(e) {
    e.target.setCustomValidity('');
};
</script>
<style>
.auth-container {
    max-width: 400px;
    margin: 3rem auto;
    padding: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.auth-container h2 {
    text-align: center;
    margin-bottom: 1.5rem;
}
.error-message {
    background: #fee;
    color: #c33;
    padding: 0.8rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    display: none;
}
.success-message {
    background: #efe;
    color: #3c3;
    padding: 0.8rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    display: none;
}
</style>
{% endblock %}
