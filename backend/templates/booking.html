{% extends "base.html" %}

{% block title %}Запись на консультацию | Сила жизни | Таганрог{% endblock %}

{% block content %}
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <div class="hero-image-block">
                <img src="/static/images/lifepower.jpeg" alt="Центр Сила жизни" class="hero-image">
            </div>
            <div class="hero-text">
                <h2>Запись на консультацию</h2>
                <p>Заполните форму, и мы свяжемся с Вами</p>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <section>
        <div style="margin-top: 1rem;">
            <h2>Запись на консультацию</h2>
            <p>Оставьте заявку, и мы свяжемся с Вами в ближайшее время для уточнения деталей и записи.</p>

            <form class="contact-form" id="contactForm">
                <div class="form-group">
                    <label for="name">Ваше имя *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="phone">Телефон *</label>
                    <input type="tel" id="phone" name="phone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div class="form-group">
                    <label for="email">Электронная почта</label>
                    <input type="email" id="email" name="email" placeholder="example@mail.com">
                </div>

                <div class="form-group">
                    <label for="service">Интересующая услуга</label>
                    <select id="service" name="service" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        <option value="">Выберите услугу</option>
                        <option value="nutrition">Нутрициология</option>
                        <option value="hirudotherapy">Гирудотерапия</option>
                        <option value="massage">Биоэнергетический массаж</option>
                        <option value="phytobarrel">Фитобочка</option>
                        <option value="stress">Управление стрессом</option>
                        <option value="complex">Комплексная программа</option>
                        <option value="consultation">Первичная консультация</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="message">Комментарий</label>
                    <textarea id="message" name="message" placeholder="Расскажите о своих пожеланиях или вопросах"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agreePrivacy" required>
                        Я согласен с <a href="/privacy" target="_blank">политикой конфиденциальности</a> и даю согласие на обработку персональных данных *
                    </label>
                </div>

                <button type="submit" class="btn">Отправить заявку</button>
            </form>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/auth.js"></script>
<script src="/static/js/form.js"></script>
<script>
// Автозаполнение для залогиненных пользователей
async function prefillForm() {
    const user = await getCurrentUser();
    if (user) {
        document.getElementById('name').value = user.name;
        document.getElementById('phone').value = user.phone;
        document.getElementById('email').value = user.email;
    }
}
prefillForm();

document.getElementById('contactForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!document.getElementById('agreePrivacy').checked) {
        alert('Необходимо согласиться с политикой конфиденциальности');
        return;
    }

    const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        service: document.getElementById('service').value,
        message: document.getElementById('message').value
    };

    try {
        const response = await apiRequest('/bookings', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Спасибо за Вашу заявку! Мы свяжемся с Вами в ближайшее время.');
            this.reset();
        } else {
            alert('Ошибка при отправке заявки. Пожалуйста, попробуйте позже.');
        }
    } catch (error) {
        alert('Ошибка подключения к серверу');
    }
});

// Кастомные сообщения валидации
document.getElementById('name').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите ваше имя');
};
document.getElementById('name').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('phone').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите номер телефона');
};
document.getElementById('phone').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('email').oninvalid = function(e) {
    if (e.target.validity.valueMissing) {
        e.target.setCustomValidity('Пожалуйста, введите email адрес');
    } else if (e.target.validity.typeMismatch) {
        e.target.setCustomValidity('Пожалуйста, введите корректный email адрес');
    }
};
document.getElementById('email').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('agreePrivacy').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, согласитесь с политикой конфиденциальности');
};
document.getElementById('agreePrivacy').onchange = function(e) {
    e.target.setCustomValidity('');
};
</script>
{% endblock %}
