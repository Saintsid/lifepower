{% extends "base.html" %}

{% block title %}Запись на консультацию | Сила жизни | Таганрог{% endblock %}

{% block content %}

{% set page_title = "Запись на консультацию" %}
{% set page_subtitle = "Оставьте заявку, и мы свяжемся с Вами в ближайшее время" %}
{% include 'components/page_header.html' %}

<div class="container">
    <section>

            <form class="contact-form" id="contactForm">
                <div class="form-group">
                    <label for="name">Ваше имя *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="phone">Телефон *</label>
                    <input type="tel" id="phone" name="phone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div class="form-group">
                    <label for="email">Электронная почта</label>
                    <input type="email" id="email" name="email" placeholder="example@mail.com">
                </div>

                <div class="form-group">
                    <label for="service">Интересующая услуга</label>
                    <select id="service" name="service" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        <option value="">Выберите услугу</option>
                        <option value="nutrition">Нутрициология</option>
                        <option value="hirudotherapy">Гирудотерапия</option>
                        <option value="massage">Биоэнергетический массаж</option>
                        <option value="phytobarrel">Фитобочка</option>
                        <option value="stress">Управление стрессом</option>
                        <option value="complex">Комплексная программа</option>
                        <option value="consultation">Первичная консультация</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="message">Комментарий</label>
                    <textarea id="message" name="message" placeholder="Расскажите о своих пожеланиях или вопросах"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="agreePrivacy" required>
                        Я согласен с <a href="/privacy" target="_blank">политикой конфиденциальности</a> и даю согласие на обработку персональных данных *
                    </label>
                </div>

                <button type="submit" class="btn">Отправить заявку</button>
            </form>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/auth.js"></script>
<script src="/static/js/form.js"></script>
<script>
// Автозаполнение для залогиненных пользователей
async function prefillForm() {
    const user = await getCurrentUser();
    if (user) {
        document.getElementById('name').value = user.name;
        document.getElementById('phone').value = user.phone;
        document.getElementById('email').value = user.email;
    }
}
prefillForm();

document.getElementById('contactForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!document.getElementById('agreePrivacy').checked) {
        alert('Необходимо согласиться с политикой конфиденциальности');
        return;
    }

    const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        service: document.getElementById('service').value,
        message: document.getElementById('message').value
    };

    // Показываем индикатор загрузки
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Отправка...';

    try {
        const response = await apiRequest('/bookings', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            // Отправляем цель в Яндекс.Метрику
            if (typeof ym !== 'undefined') {
                ym(104857779, 'reachGoal', 'booking_submit');
            }
            
            alert('Спасибо за Вашу заявку! Мы свяжемся с Вами в ближайшее время.');
            this.reset();
            
            // Если пользователь авторизован, предлагаем перейти в ЛК
            const user = await getCurrentUser();
            if (user && confirm('Хотите посмотреть Ваши записи в личном кабинете?')) {
                window.location.href = '/client-dashboard';
            }
        } else {
            const error = await response.json().catch(() => ({}));
            alert(error.detail || 'Ошибка при отправке заявки. Пожалуйста, попробуйте позже или позвоните нам.');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка подключения к серверу. Пожалуйста, проверьте интернет-соединение.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
    }
});

// Кастомные сообщения валидации
document.getElementById('name').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите ваше имя');
};
document.getElementById('name').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('phone').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, введите номер телефона');
};
document.getElementById('phone').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('email').oninvalid = function(e) {
    if (e.target.validity.valueMissing) {
        e.target.setCustomValidity('Пожалуйста, введите email адрес');
    } else if (e.target.validity.typeMismatch) {
        e.target.setCustomValidity('Пожалуйста, введите корректный email адрес');
    }
};
document.getElementById('email').oninput = function(e) {
    e.target.setCustomValidity('');
};

document.getElementById('agreePrivacy').oninvalid = function(e) {
    e.target.setCustomValidity('Пожалуйста, согласитесь с политикой конфиденциальности');
};
document.getElementById('agreePrivacy').onchange = function(e) {
    e.target.setCustomValidity('');
};
</script>
{% endblock %}
